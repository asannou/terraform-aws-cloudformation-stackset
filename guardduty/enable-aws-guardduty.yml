AWSTemplateFormatVersion: '2010-09-09'
Description: Creates an AWS::GuardDuty::Detector resource and optionally AWS::GuardDuty::* resources in a set of accounts and regions.
Parameters:
  MasterId:
    Type: String
    Default: ''
    Description: >
      The Amazon GuardDuty master account ID. If you specify the master account ID, this stack set creates a GuardDuty detector in each specified account and accepts the GuardDuty membership invitation sent to each of the specified accounts by this master account. If this value is specified, before you can
      create this stack set, all accounts in all regions to which this stack set template is to be applied must already have an invitation from this master GuardDuty account and must NOT have a detector already created.
  FindingPublishingFrequency:
    Default: SIX_HOURS
    Type: String
    AllowedValues:
      - FIFTEEN_MINUTES
      - ONE_HOUR
      - SIX_HOURS
  IPSetLocation:
    Type: String
    Default: ''
  ThreatIntelSetLocation:
    Type: String
    Default: ''
Conditions:
  CreateMasterResource: !Not
    - !Equals
      - !Ref MasterId
      - ''
  CreateIPSetResource: !Not
    - !Equals
      - !Ref IPSetLocation
      - ''
  CreateThreatIntelSet: !Not
    - !Equals
      - !Ref ThreatIntelSetLocation
      - ''
Resources:
  Detector:
    Type: AWS::GuardDuty::Detector
    Properties:
      Enable: True
      FindingPublishingFrequency: !Ref FindingPublishingFrequency
  Member:
    Type: Custom::GuardDutyMember
    Condition: CreateMasterResource
    Properties:
      ServiceToken: !Sub arn:aws:sns:${AWS::Region}:${MasterId}:test
  Master:
    Type: AWS::GuardDuty::Master
    Condition: CreateMasterResource
    Properties:
      DetectorId: !Ref Detector
      MasterId: !Ref MasterId
    DependsOn: Member
  IPSet:
    Type: AWS::GuardDuty::IPSet
    Condition: CreateIPSetResource
    Properties:
      Activate: True
      DetectorId: !Ref Detector
      Format: TXT
      Location: !Ref IPSetLocation
  ThreatIntelSet:
    Type: AWS::GuardDuty::ThreatIntelSet
    Condition: CreateThreatIntelSet
    Properties:
      Activate: True
      DetectorId: !Ref Detector
      Format: TXT
      Location: !Ref ThreatIntelSetLocation
